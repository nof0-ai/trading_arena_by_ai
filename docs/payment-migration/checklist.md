# 支付模块迁移 Checklist

- [ ] 明确支付服务的职责范围：列出当前项目内涉及 Stripe/结算的 API、Webhook、队列、前端组件。
- [ ] 梳理依赖关系：确认支付逻辑依赖的数据库 schema、环境变量、配置服务，避免硬编码。
- [ ] 规划服务边界：定义新服务对外暴露的 REST/事件接口，约定请求与响应格式。
- [ ] 抽离配置与密钥：整理 Stripe、Supabase 等必须的配置，确保默认值为空，通过配置注入。
- [ ] 迁移核心代码：将 `app/api/create-checkout-session`、`lib/stripe`、`components/stripe-checkout` 等相关模块迁移到新仓库或包。
- [ ] 建立通信通道：为主项目与支付服务之间的调用设计认证、重试、错误返回策略，保持 fail-fast 并附带堆栈。
- [ ] 迁移数据库脚本：复制与支付相关的 SQL 脚本（如 `scripts/028_add_price_candles_webhook_trigger.sql` 等），根据新环境计划执行顺序。
- [ ] 搭建测试流程：为新服务编写最小可行的单元、集成、Webhook 端到端测试，覆盖异常输入与配置缺失场景。
- [ ] 配置 CI/CD：建立构建、部署和滚动发布流程，确保上线前可追踪版本与回滚方案。
- [ ] 渐进式切流：在主项目中切换到新支付服务的调用路径，监控日志与指标，确认无遗留依赖后清理旧逻辑。
- [ ] 复盘与文档：记录迁移决策、接口契约、运维指引，方便团队共享与后续迭代。
